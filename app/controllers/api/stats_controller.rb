class Api::StatsController < Api::BaseController
  before_action :validate_params
  before_action :load_user_and_stats
  before_action :discard_repeated_actions

  NEW_ASSIGNMENT_ACTIONS = ["review_started", "review_assigned"].freeze
  NEW_UNASSIGNMENT_ACTIONS = ["review_unassigned", "review_finished"].freeze
  REVIEW_START = ["review_started"].freeze
  REVIEW_FINISH = ["review_finished"].freeze

  VALID_ACTIONS = NEW_ASSIGNMENT_ACTIONS + NEW_UNASSIGNMENT_ACTIONS

  def update
    if NEW_ASSIGNMENT_ACTIONS.include?(params[:what])
      @user_stats.active_reviews += 1
    end

    if NEW_UNASSIGNMENT_ACTIONS.include?(params[:what])
      @user_stats.active_reviews -= 1 unless @user_stats.active_reviews == 0
    end

    if REVIEW_FINISH.include?(params[:what])
      @user_stats.reviews_all_time += 1
      @user_stats.last_review_on = Time.now
    end

    @user_stats.save
  end

  private

  def validate_params
    render plain: "Invalid param: action", status: :unprocessable_entity unless VALID_ACTIONS.include?(params[:what])
  end

  def load_user_and_stats
    github_handle = params[:username].sub("@", "")
    @user = User.includes(:stat).find_by! github: github_handle
    @user_stats = @user.stat
  end

  def discard_repeated_actions
    if params["idempotency_key"].present?
      if params["idempotency_key"] == @user_stats.last_action_key
        head :bad_request
      else
        @user_stats.last_action_key = params["idempotency_key"]
      end
    end
  end
end
